<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢è¯•æ—¥å†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f5f7fa;
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 0;
        }
        
        h1 {
            font-size: 24px;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sync-btn {
            background: #4a6cf7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 8px rgba(74, 108, 247, 0.25);
        }
        
        .sync-btn:hover {
            background: #3b5be3;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(74, 108, 247, 0.3);
        }
        
        .sync-btn:active {
            transform: translateY(0);
        }
        
        .calendar-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #4a6cf7;
            color: white;
        }
        
        .month-navigation {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .current-month {
            font-size: 22px;
            font-weight: 600;
        }
        
        .today-btn {
            background: white;
            color: #4a6cf7;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .today-btn:hover {
            background: #f0f4ff;
        }
        
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: #f0f4ff;
            padding: 12px 0;
            text-align: center;
            font-weight: 600;
            color: #4a5c6c;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #eef2f8;
        }
        
        .calendar-day {
            min-height: 130px;
            background: white;
            padding: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .calendar-day:hover {
            background: #f9fafd;
        }
        
        .day-number {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #4a5c6c;
        }
        
        .event-card {
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .event-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .event-company {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .event-type {
            opacity: 0.9;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7a8aa0;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            color: #ccd4e0;
        }
        
        .empty-state p {
            font-size: 18px;
            margin-bottom: 24px;
        }
        
        .connected {
            border: 2px solid #4a6cf7;
            box-shadow: 0 0 0 2px rgba(74, 108, 247, 0.3);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #4a6cf7;
        }
        
        .spinner {
            border: 4px solid rgba(74, 108, 247, 0.1);
            border-radius: 50%;
            border-top: 4px solid #4a6cf7;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-events {
            color: #aab7c5;
            font-style: italic;
            font-size: 12px;
        }

        .other-month {
            background-color: #f9f9f9;
            color: #ccc;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <i class="icon">ğŸ“…</i> é¢è¯•æ—¥å†
            </h1>
            <button class="sync-btn" id="syncButton">
                <i class="icon">ğŸ”„</i> åŒæ­¥é‚®ç®±
            </button>
        </header>
        
        <div class="calendar-container">
            <div class="calendar-header">
                <div class="month-navigation">
                    <button class="nav-btn" id="prevMonth">â†</button>
                    <div class="current-month" id="currentMonth">2025å¹´8æœˆ</div>
                    <button class="nav-btn" id="nextMonth">â†’</button>
                </div>
                <button class="today-btn" id="todayButton">ä»Šå¤©</button>
            </div>
            
            <div class="weekdays">
                <div>å‘¨æ—¥</div>
                <div>å‘¨ä¸€</div>
                <div>å‘¨äºŒ</div>
                <div>å‘¨ä¸‰</div>
                <div>å‘¨å››</div>
                <div>å‘¨äº”</div>
                <div>å‘¨å…­</div>
            </div>
            
            <div class="calendar-grid" id="calendarGrid">
                <!-- æ—¥å†å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <p>æ­£åœ¨åŒæ­¥é‚®ç®±æ•°æ®ï¼Œè¯·ç¨å€™...</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // å½“å‰æ˜¾ç¤ºçš„æ—¥æœŸ
            let currentDate = new Date();
            // å­˜å‚¨ä»åç«¯è·å–çš„äº‹ä»¶æ•°æ®
            let eventsData = [];
            
            // è·å–DOMå…ƒç´ 
            const syncButton = document.getElementById('syncButton');
            const prevMonthButton = document.getElementById('prevMonth');
            const nextMonthButton = document.getElementById('nextMonth');
            const todayButton = document.getElementById('todayButton');
            const currentMonthElement = document.getElementById('currentMonth');
            const calendarGrid = document.getElementById('calendarGrid');
            const loadingIndicator = document.getElementById('loadingIndicator');
            
            // åˆå§‹åŒ–æ—¥å†
            renderCalendar(currentDate);
            
            // æ·»åŠ äº‹ä»¶å§”æ‰˜å¤„ç†
            addGlobalEventListeners();
            
            // åŒæ­¥æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            syncButton.addEventListener('click', function() {
                syncEmailData();
            });
            
            // ä¸Šä¸ªæœˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            prevMonthButton.addEventListener('click', function() {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar(currentDate);
            });
            
            // ä¸‹ä¸ªæœˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            nextMonthButton.addEventListener('click', function() {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar(currentDate);
            });
            
            // ä»Šå¤©æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            todayButton.addEventListener('click', function() {
                currentDate = new Date();
                renderCalendar(currentDate);
            });
            
            // åŒæ­¥é‚®ç®±æ•°æ®
            function syncEmailData() {
    loadingIndicator.style.display = 'block';
    
    fetch('http://localhost:8080/email/findAllEmail')
        .then(response => {
            if (!response.ok) {
                throw new Error('ç½‘ç»œå“åº”ä¸æ­£å¸¸: ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            console.log('æ¥æ”¶åˆ°çš„æ•°æ®:', data);
            
            // å…³é”®ä¿®æ”¹ï¼šæ£€æŸ¥æ•°æ®ç»“æ„æ˜¯å¦æ­£ç¡®
            // å¦‚æœåç«¯ç›´æ¥è¿”å›æ•°ç»„è€ŒéåŒ…å«eventså±æ€§çš„å¯¹è±¡
            eventsData = Array.isArray(data) ? data : (data.events || []);
            
            // éªŒè¯æ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®
            if (eventsData.length > 0) {
                console.log('ç¬¬ä¸€ä¸ªäº‹ä»¶æ•°æ®:', eventsData[0]);
                // æ£€æŸ¥æ˜¯å¦æœ‰å¿…è¦çš„å­—æ®µ
                const requiredFields = ['id', 'company', 'scheduledTime', 'emailReceiveTime'];
                const firstEvent = eventsData[0];
                const missingFields = requiredFields.filter(field => !(field in firstEvent));
                if (missingFields.length > 0) {
                    console.warn('äº‹ä»¶æ•°æ®ç¼ºå°‘å¿…è¦å­—æ®µ:', missingFields);
                }
            }
            
            loadingIndicator.style.display = 'none';
            // å¼ºåˆ¶é‡æ–°æ¸²æŸ“æ—¥å†
            renderCalendar(currentDate);
        })
        .catch(error => {
            console.error('è·å–æ•°æ®æ—¶å‡ºé”™:', error);
            loadingIndicator.style.display = 'none';
            alert('åŒæ­¥å¤±è´¥: ' + error.message);
        });
}
            
            // æ¸²æŸ“æ—¥å†
            function renderCalendar(date) {
                const year = date.getFullYear();
                const month = date.getMonth();
                
                // æ›´æ–°å½“å‰å¹´æœˆæ˜¾ç¤º
                currentMonthElement.textContent = `${year}å¹´${month + 1}æœˆ`;
                
                // æ¸…ç©ºæ—¥å†ç½‘æ ¼
                calendarGrid.innerHTML = '';
                
                // è·å–å½“æœˆç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                
                // è·å–å½“æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡ ï¼ˆ0æ˜¯å‘¨æ—¥ï¼‰
                const firstDayIndex = firstDay.getDay();
                
                // è·å–å½“æœˆæ€»å¤©æ•°
                const daysInMonth = lastDay.getDate();
                
                // è·å–ä¸Šä¸ªæœˆçš„æœ€åå‡ å¤©ï¼ˆç”¨äºå¡«å……æ—¥å†å¼€å¤´ï¼‰
                const prevLastDay = new Date(year, month, 0).getDate();
                
                // ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µå‡å°‘DOMé‡ç»˜
                const fragment = document.createDocumentFragment();
                
                // ä¸Šä¸ªæœˆçš„æ—¥å­
                for (let i = firstDayIndex; i > 0; i--) {
                    const day = prevLastDay - i + 1;
                    const cell = createDayCellElement(day, month - 1, true);
                    fragment.appendChild(cell);
                }
                
                // å½“æœˆçš„æ—¥å­
                for (let i = 1; i <= daysInMonth; i++) {
                    const cell = createDayCellElement(i, month, false);
                    fragment.appendChild(cell);
                }
                
                // ä¸‹ä¸ªæœˆçš„æ—¥å­ï¼ˆå¡«å……æ—¥å†ç»“å°¾ï¼‰
                const nextDays = 42 - (firstDayIndex + daysInMonth); // 42æ˜¯6è¡Œ7åˆ—
                for (let i = 1; i <= nextDays; i++) {
                    const cell = createDayCellElement(i, month + 1, true);
                    fragment.appendChild(cell);
                }
                
                // ä¸€æ¬¡æ€§æ·»åŠ æ‰€æœ‰å•å…ƒæ ¼åˆ°DOM
                calendarGrid.appendChild(fragment);
            }
            
            // åˆ›å»ºæ—¥æœŸå•å…ƒæ ¼å…ƒç´ 
            function createDayCellElement(day, cellMonth, isOtherMonth) {
                const cellHTML = createDayCell(day, cellMonth, isOtherMonth);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = cellHTML;
                return tempDiv.firstElementChild;
            }
            
            // åˆ›å»ºæ—¥æœŸå•å…ƒæ ¼HTML
            function createDayCell(day, cellMonth, isOtherMonth) {
                const currentYear = currentDate.getFullYear();
                
                // åˆ›å»ºæ—¥æœŸå¯¹è±¡
                const cellDate = new Date(currentYear, cellMonth, day);
                const dateString = formatDate(cellDate);
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºä»Šå¤©
                const today = new Date();
                const isToday = today.toDateString() === cellDate.toDateString();
                
                // æ£€æŸ¥è¯¥æ—¥æœŸæ˜¯å¦æœ‰äº‹ä»¶
                const dayEvents = eventsData.filter(event => {
        try {
            // å¤„ç†ä¸åŒæ ¼å¼çš„æ—¥æœŸå­—ç¬¦ä¸²
            const emailDate = new Date(event.emailReceiveTime).toISOString().split('T')[0];
            const scheduledDate = new Date(event.scheduledTime).toISOString().split('T')[0];
            return emailDate === dateString || scheduledDate === dateString;
        } catch (error) {
            console.error('æ—¥æœŸæ ¼å¼é”™è¯¯:', event, error);
            return false;
        }
    });
                
                // ç”Ÿæˆäº‹ä»¶å¡ç‰‡HTML
                let eventsHTML = '';
                if (dayEvents.length > 0) {
                    dayEvents.forEach(event => {
                        const isEmailDate = event.emailReceiveTime.split(' ')[0] === dateString;
                        const eventDateType = isEmailDate ? 'æ”¶åˆ°é‚®ä»¶' : 'å®‰æ’æ—¶é—´';
                        
                        eventsHTML += `
                            <div class="event-card" data-event-id="${event.id}" style="background: ${event.color};">
                                <div class="event-company">${event.company}</div>
                                <div class="event-type">${event.type} - ${eventDateType}</div>
                            </div>
                        `;
                    });
                } else {
                    if (!isOtherMonth) {
                        eventsHTML = `<div class="no-events">æ— å®‰æ’</div>`;
                    }
                }
                
                // æ·»åŠ æœ‰äº‹ä»¶/æ— äº‹ä»¶çš„æ ‡è¯†ç±»
                const eventClass = dayEvents.length > 0 ? 'has-events' : 'no-events';
                
                return `
                    <div class="calendar-day ${isOtherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''} ${eventClass}" data-date="${dateString}">
                        <div class="day-number">${day}</div>
                        ${eventsHTML}
                    </div>
                `;
            }
            
            // æ·»åŠ å…¨å±€äº‹ä»¶ç›‘å¬å™¨ï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
            function addGlobalEventListeners() {
                // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æ—¥å†ç½‘æ ¼ä¸­çš„æ‰€æœ‰ç‚¹å‡»
                calendarGrid.addEventListener('click', function(e) {
                    const dayElement = e.target.closest('.calendar-day');
                    const eventCard = e.target.closest('.event-card');
                    
                    // æ— è®ºç‚¹å‡»ä»€ä¹ˆï¼Œå…ˆæ¸…é™¤æ‰€æœ‰å·²æœ‰çš„è¾¹æ¡†
                    document.querySelectorAll('.connected').forEach(el => {
                        el.classList.remove('connected');
                    });
                    
                    if (eventCard) {
                        // å¤„ç†äº‹ä»¶å¡ç‰‡ç‚¹å‡»
                        e.stopPropagation();
                        const eventId = eventCard.getAttribute('data-event-id');
                        const event = eventsData.find(e => e.id === eventId);
                        
                        if (event) {
                            // é«˜äº®å…³è”çš„æ—¥æœŸ
                            const emailDate = event.emailReceiveTime.split(' ')[0];
                            const scheduledDate = event.scheduledTime.split(' ')[0];
                            
                            const emailElement = document.querySelector(`.calendar-day[data-date="${emailDate}"]`);
                            if (emailElement) emailElement.classList.add('connected');
                            
                            const scheduledElement = document.querySelector(`.calendar-day[data-date="${scheduledDate}"]`);
                            if (scheduledElement) scheduledElement.classList.add('connected');
                            
                            // åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€é“¾æ¥
                            window.open(event.link, '_blank');
                        }
                    } else if (dayElement && !dayElement.classList.contains('other-month')) {
                        // å¤„ç†æ—¥æœŸå•å…ƒæ ¼ç‚¹å‡»ï¼ˆæ’é™¤å…¶ä»–æœˆä»½ï¼‰
                        const date = dayElement.getAttribute('data-date');
                        
                        // æŸ¥æ‰¾è¯¥æ—¥æœŸçš„äº‹ä»¶
                        const dateEvents = eventsData.filter(event => {
                            const emailDate = event.emailReceiveTime.split(' ')[0];
                            const scheduledDate = event.scheduledTime.split(' ')[0];
                            return emailDate === date || scheduledDate === date;
                        });
                        
                        // åªæœ‰å½“æœ‰äº‹ä»¶æ—¶æ‰æ·»åŠ è¾¹æ¡†
                        if (dateEvents.length > 0) {
                            dateEvents.forEach(event => {
                                const emailDate = event.emailReceiveTime.split(' ')[0];
                                const scheduledDate = event.scheduledTime.split(' ')[0];
                                
                                const emailElement = document.querySelector(`.calendar-day[data-date="${emailDate}"]`);
                                if (emailElement) emailElement.classList.add('connected');
                                
                                const scheduledElement = document.querySelector(`.calendar-day[data-date="${scheduledDate}"]`);
                                if (scheduledElement) scheduledElement.classList.add('connected');
                            });
                        }
                    }
                });
            }
            
            // æ ¼å¼åŒ–æ—¥æœŸä¸ºYYYY-MM-DD
            function formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            // æ¨¡æ‹Ÿæ•°æ®åŠ è½½
            setTimeout(() => {
                eventsData = [
                    {
                        "id": "mengjia_17468490",
                        "company": "å¦é—¨è‚¡ä»½æœ‰é™å…¬å¸",
                        "position": "JavaæœåŠ¡ç«¯ç¨‹åºï¼ˆå¦é—¨-å®ä¹ ï¼‰",
                        "type": "ç¬”è¯•",
                        "link": "https://exam.nowcoder.com/cts/xxxx",
                        "scheduledTime": "2025-09-05 15:00:00",
                        "emailReceiveTime": "2025-08-31 09:56:21",
                        "color": "#1E88E5"
                    },
                    {
                        "id": "duoyi_15302253560",
                        "company": "ojbkgå…¬å¸",
                        "position": "æœªæ˜ç¡®ï¼ˆéœ€ä»é‚®ä»¶æ¨æ–­ï¼‰",
                        "type": "é¢è¯•",
                        "link": "https://baidu.com",
                        "scheduledTime": "2025-09-02 13:30:00",
                        "emailReceiveTime": "2025-09-12 16:53:48",
                        "color": "#43A047"
                    }
                ];
                renderCalendar(currentDate);
            }, 500);
        });
    </script>
</body>
</html>